# 13. Протокол DHCP. Режимы работы DHCP: ручной, автоматический и динамический.

## Общие сведения о протоколе DHCP

DHCP (Dynamic Host Configuration Protocol - протокол динамической настройки узла) — это сетевой протокол, позволяющий устройствам автоматически получать IP-адрес и другие параметры конфигурации, необходимые для работы в сети TCP/IP. Протокол был впервые представлен в октябре 1993 года и описан в стандарте RFC 2131. Он пришел на смену протоколу BOOTP, который не поддерживал динамическое назначение IP-адресов.

До появления DHCP сетевые адреса назначались компьютерам вручную администраторами. При этом нужно было следить, какой машине какой адрес выдан и какие остались свободны. Это занимало много времени и часто приводило к ошибкам, особенно в больших сетях. Протокол DHCP автоматизировал процесс назначения сетевых адресов, значительно упростив администрирование сетей.

Каждое устройство в сети TCP/IP должно иметь уникальный IP-адрес для идентификации в сети и обмена данными. DHCP автоматически выдает эти адреса из заранее определенного администратором пула адресов. Помимо IP-адреса, DHCP также передает клиентам маску подсети, адрес шлюза по умолчанию, адреса DNS-серверов и другие параметры конфигурации.

## Архитектура DHCP

DHCP работает по модели клиент-сервер. В этой архитектуре присутствуют два ключевых компонента: DHCP-сервер и DHCP-клиент.

DHCP-сервер - это программа или устройство (компьютер, маршрутизатор), которое хранит информацию о доступных IP-адресах и выдает их клиентам по запросу. В локальной сети обычно назначается один или несколько DHCP-серверов. Сервер слушает запросы на UDP-порту 67 и отправляет ответы клиентам на UDP-порт 68.

DHCP-клиент - это любое устройство (компьютер, ноутбук, смартфон, принтер), которому необходимо получить IP-адрес для работы в сети. При подключении к сети клиент обращается к DHCP-серверу с запросом на получение сетевой конфигурации.

Передача данных между клиентом и сервером происходит с использованием протокола UDP. Все сообщения DHCP имеют определенный формат с полями фиксированной длины (кроме поля опций). Сообщения инкапсулируются в UDP-дейтаграммы и передаются по сети.

## Режимы работы DHCP

DHCP-сервер может назначать IP-адреса клиентам тремя различными способами: ручным (статическим), автоматическим и динамическим. Выбор режима зависит от требований сети и характера использования устройств.

### Ручное (статическое) распределение

При ручном распределении сетевой администратор явно сопоставляет MAC-адрес каждого клиентского устройства с определенным IP-адресом в конфигурации DHCP-сервера. Когда устройство с указанным MAC-адресом подключается к сети, сервер всегда выдает ему один и тот же, закрепленный за ним IP-адрес.

Этот режим фактически отличается от полностью ручной настройки каждого компьютера лишь тем, что информация об адресах хранится централизованно на сервере DHCP, а не в настройках каждого устройства. Это упрощает внесение изменений - администратору не нужно физически обходить все компьютеры для изменения их настроек, достаточно изменить конфигурацию на сервере.

Ручное распределение имеет смысл использовать для критически важных устройств, которым необходим постоянный IP-адрес: серверов, сетевых принтеров, маршрутизаторов, систем видеонаблюдения. Также этот режим применяется в небольших сетях, где количество устройств ограничено и редко меняется.

### Автоматическое распределение

При автоматическом распределении DHCP-сервер выделяет каждому устройству произвольный свободный IP-адрес из определенного администратором диапазона, причем этот адрес выдается на постоянное использование. Время аренды адреса не ограничено - адрес остается закрепленным за устройством до тех пор, пока клиент от него явно не откажется.

Отличие от ручного режима в том, что администратор не участвует в составлении таблицы соответствий - она создается на сервере автоматически по мере подключения новых устройств. Сервер самостоятельно выбирает свободный адрес из пула и назначает его клиенту при первом подключении.

Отличие от динамического режима заключается в том, что однажды получив адрес, клиент сохраняет его навсегда и не обращается за новым при последующих подключениях. Адрес не возвращается в пул доступных адресов, пока устройство не будет удалено из сети.

Автоматический режим удобен для сетей, где устройства подключаются на длительное время и желательно, чтобы их адреса оставались неизменными, но при этом нет необходимости жестко привязывать конкретные адреса к конкретным устройствам вручную.

### Динамическое распределение

Динамическое распределение - наиболее распространенный режим работы DHCP. При этом способе сервер выдает клиенту любой свободный IP-адрес из определенного диапазона на ограниченный срок, который называется временем аренды (lease time). Типичное время аренды составляет от нескольких часов до нескольких дней (часто 1-8 дней).

Ключевая особенность динамического режима в том, что IP-адреса не закрепляются за конкретными устройствами навсегда. После истечения срока аренды адрес возвращается в пул свободных адресов и может быть выдан другому клиенту. Клиент может продлить аренду, отправив соответствующий запрос до истечения срока.

Динамический режим особенно эффективен в ситуациях, когда количество доступных IP-адресов ограничено, а число потенциальных клиентов превышает размер пула адресов, но не все клиенты работают в сети одновременно. Например, в офисе на 200 сотрудников может быть выделено только 150 IP-адресов, если известно, что одновременно работают не более 150 человек.

Этот режим идеально подходит для публичных Wi-Fi сетей в кафе, торговых центрах, аэропортах, где состав пользователей постоянно меняется. Также он используется для подключения мобильных устройств, которые часто перемещаются между разными сегментами сети.

## Процесс DORA

Процесс получения IP-адреса клиентом от DHCP-сервера состоит из четырех основных этапов, которые обозначаются аббревиатурой DORA: Discover (обнаружение), Offer (предложение), Request (запрос) и Acknowledge (подтверждение).

**1. DHCP Discover (обнаружение)**

Когда устройство подключается к сети или загружается, DHCP-клиент отправляет широковещательное сообщение DHCPDISCOVER для поиска доступных DHCP-серверов. Это сообщение рассылается на адрес 255.255.255.255 (широковещательный адрес), так как клиент еще не знает адрес сервера. В качестве IP-адреса источника указывается 0.0.0.0, поскольку у клиента пока нет собственного IP-адреса. На канальном уровне используется широковещательный MAC-адрес FF:FF:FF:FF:FF:FF. Сообщение содержит MAC-адрес клиента и может включать запрос на конкретный IP-адрес, если клиент хочет получить тот же адрес, что использовал ранее.

**2. DHCP Offer (предложение)**

Все DHCP-серверы в сегменте сети получают сообщение DHCPDISCOVER и отвечают сообщением DHCPOFFER. Сервер резервирует свободный IP-адрес из своего пула и отправляет предложение клиенту. Сообщение содержит предлагаемый IP-адрес, маску подсети, адрес шлюза по умолчанию, адреса DNS-серверов, время аренды и IP-адрес самого DHCP-сервера. На сетевом уровне сообщение все еще отправляется широковещательно (255.255.255.255), так как клиент еще не имеет IP-адреса, но на канальном уровне оно направлено конкретно на MAC-адрес клиента (уникастное на уровне 2). Если в сети несколько DHCP-серверов, клиент может получить несколько предложений.

**3. DHCP Request (запрос)**

Клиент выбирает одно из полученных предложений (обычно то, которое пришло первым) и отправляет сообщение DHCPREQUEST, информируя выбранный сервер о принятии его предложения. Это сообщение также отправляется широковещательно на адрес 255.255.255.255, чтобы все остальные DHCP-серверы, которые сделали предложения, узнали о выборе клиента и вернули зарезервированные ими адреса обратно в пул доступных. Сообщение содержит идентификатор выбранного сервера и запрашиваемый IP-адрес.

**4. DHCP Acknowledge (подтверждение)**

Выбранный DHCP-сервер получает сообщение DHCPREQUEST и отправляет финальное подтверждение DHCPACK клиенту. Это сообщение подтверждает назначение IP-адреса и содержит полную конфигурацию: IP-адрес, маску подсети, шлюз, DNS-серверы, время аренды и другие опции. После получения DHCPACK клиент настраивает свой сетевой интерфейс с полученными параметрами и может начинать полноценную работу в сети. Если по каким-то причинам сервер не может выполнить запрос (например, адрес уже занят), он отправляет сообщение DHCPNAK (отказ), и процесс начинается заново.

Весь процесс DORA обычно занимает несколько миллисекунд и происходит полностью автоматически, без участия пользователя. Клиент также может периодически продлевать аренду, отправляя запросы DHCPREQUEST непосредственно серверу (уникастом), когда истекает около 50% времени аренды.

## Преимущества и недостатки DHCP

Использование DHCP предоставляет множество преимуществ. Автоматизация настройки значительно сокращает время и усилия администраторов, особенно в больших сетях. Централизованное управление IP-адресами упрощает их изменение и мониторинг. Динамическое распределение позволяет эффективно использовать ограниченный пул адресов. Снижается количество ошибок конфигурации и конфликтов адресов. Мобильные устройства могут легко перемещаться между сегментами сети, автоматически получая новые адреса.

Однако у DHCP есть и недостатки. Если DHCP-сервер выйдет из строя, новые устройства не смогут получить адреса (эта проблема решается резервированием серверов). DHCP создает дополнительный трафик в сети из-за широковещательных сообщений. Существуют потенциальные угрозы безопасности, такие как возможность установки поддельных DHCP-серверов или DoS-атаки. Для критически важных серверов динамическое назначение адресов нежелательно, так как их адреса должны оставаться постоянными.

**Источники:**
- https://ru.wikipedia.org/wiki/DHCP
- https://timeweb.com/ru/community/articles/chto-takoe-dhcp-protokol
- https://firstvds.ru/technology/chto-takoe-dhcp-protokol
- https://www.xelent.ru/blog/printsipy-raboty-protokola-dhcp/
