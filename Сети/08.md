# 8. Отображение IP-адресов на локальные адреса. Протоколы ARP и RARP. Пример работы ARP в сетях с широковещанием.

## Проблема отображения адресов

В компьютерных сетях каждый узел имеет два типа адресов на разных уровнях модели OSI. На сетевом уровне используется IP-адрес (32 бита), а на канальном уровне применяется физический MAC-адрес (48 бит для Ethernet). Эти адреса выбираются независимо друг от друга - IP-адрес назначается администратором или DHCP-сервером, а MAC-адрес прошивается производителем в сетевую карту. Между ними нет математической связи или алгоритма преобразования.

Проблема возникает при передаче данных. Протокол IP знает IP-адрес получателя, но для фактической передачи по Ethernet необходим MAC-адрес, так как коммутаторы работают только с MAC-адресами. Требуется механизм автоматического определения соответствия между IP и MAC адресами.

## Протокол ARP (Address Resolution Protocol)

Протокол разрешения адресов ARP был описан в RFC 826 (1982 год) для решения задачи отображения IP-адресов в физические адреса. ARP относится к сетевому уровню модели OSI и работает по принципу запрос-ответ.

Основной инструмент работы ARP - это ARP-таблица, хранящаяся в оперативной памяти каждого узла. Таблица содержит кэш соответствий между IP-адресами и MAC-адресами узлов, с которыми компьютер недавно взаимодействовал.

Когда узлу нужно отправить пакет в локальной сети, он проверяет ARP-таблицу. Если запись найдена, MAC-адрес извлекается и пакет отправляется. Если записи нет, запускается процедура динамического разрешения адреса: IP-пакет помещается в очередь, а модуль ARP формирует широковещательный запрос на адрес FF:FF:FF:FF:FF:FF.

Все узлы в сегменте получают запрос и сравнивают указанный IP-адрес со своим. Узел с совпадающим адресом формирует ARP-ответ со своим MAC-адресом и отправляет его адресно отправителю запроса. Получив ответ, отправитель сохраняет соответствие в ARP-таблице и отправляет ожидающий пакет.

Записи в ARP-таблице бывают статическими (созданы вручную) и динамическими (создаются автоматически). Динамические записи имеют ограниченное время жизни: если запись не используется 2 минуты, она удаляется. При активном использовании время продлевается, но максимум до 10 минут.

Формат пакета ARP включает: тип сети (1 для Ethernet), тип протокола (0x0800 для IP), длину аппаратного адреса (6 байт), длину адреса протокола (4 байта), код операции (1 - запрос, 2 - ответ), и поля с адресами отправителя и получателя.

## Протокол RARP (Reverse ARP)

Протокол обратного разрешения адресов RARP решает противоположную задачу - определяет IP-адрес узла по известному MAC-адресу. Он разработан для бездисковых рабочих станций, которые загружаются по сети.

При включении бездисковая станция не имеет энергонезависимой памяти для хранения IP-адреса. Единственная доступная информация - это MAC-адрес сетевой карты. Чтобы начать работу и обратиться к TFTP-серверу за образом ОС, станция должна узнать свой IP-адрес.

Бездисковая станция отправляет широковещательный RARP-запрос с указанием своего MAC-адреса. RARP-сервер получает запрос, находит в таблице соответствующий IP-адрес и отправляет RARP-ответ. Формат пакетов аналогичен ARP, но используются коды операций 3 (запрос) и 4 (ответ).

RARP отличается от InARP: RARP используется для определения собственного IP-адреса, а InARP - для определения IP-адреса другого узла. В настоящее время RARP устарел и заменен протоколами BOOTP, а затем DHCP.

## Пример работы ARP в сетях с широковещанием

Рассмотрим работу ARP на примере локальной сети Ethernet. Компьютер А (IP: 10.0.0.1, MAC: a0:ea:d1:11:f1:01) хочет передать данные компьютеру Б (IP: 10.22.22.2, MAC неизвестен). Оба находятся в одном сегменте Ethernet.

**Последовательность действий:**

1. **Формирование пакета:** На компьютере А формируется IP-пакет с адресом назначения 10.22.22.2. Для передачи по Ethernet требуется MAC-адрес получателя.

2. **Проверка ARP-таблицы:** Протокол ARP проверяет локальную таблицу на наличие записи для IP 10.22.22.2. Запись отсутствует, так как компьютеры ранее не взаимодействовали.

3. **Постановка в очередь:** IP-пакет помещается в буфер ожидания, так как не может быть немедленно отправлен.

4. **Формирование ARP-запроса:** Создается запрос с полями:
   - MAC отправителя: a0:ea:d1:11:f1:01
   - IP отправителя: 10.0.0.1
   - MAC получателя: 00:00:00:00:00:00 (пустое)
   - IP получателя: 10.22.22.2

5. **Широковещательная рассылка:** ARP-запрос инкапсулируется в Ethernet-кадр с адресом назначения FF:FF:FF:FF:FF:FF и передается по сети.

6. **Получение всеми узлами:** Кадр достигает всех узлов сегмента. Предположим, в сети есть компьютер С (IP: 10.0.0.3). Все узлы (А, Б, С) получают широковещательный кадр.

7. **Обработка запроса:** Каждый узел анализирует ARP-запрос:
   - Компьютер С сравнивает свой IP (10.0.0.3) с искомым (10.22.22.2) - несовпадение, запрос игнорируется
   - Компьютер Б сравнивает свой IP (10.22.22.2) с искомым (10.22.22.2) - совпадение!

8. **Формирование ARP-ответа:** Компьютер Б создает ответ с полями:
   - MAC отправителя: 00:ea:d1:11:f1:11
   - IP отправителя: 10.22.22.2
   - MAC получателя: a0:ea:d1:11:f1:01 (адресно!)
   - IP получателя: 10.0.0.1

9. **Адресная отправка ответа:** ARP-ответ отправляется напрямую компьютеру А по его MAC-адресу, а не широковещательно.

10. **Обновление таблицы:** Компьютер А получает ответ и добавляет в ARP-таблицу запись: `10.22.22.2 → 00:ea:d1:11:f1:11`

11. **Передача данных:** IP-пакет извлекается из очереди, инкапсулируется в Ethernet-кадр с MAC-адресом назначения 00:ea:d1:11:f1:11 и отправляется компьютеру Б.

**Важные особенности работы в широковещательных сетях:**

ARP работает только в пределах одного широковещательного домена - маршрутизаторы не пропускают широковещательные запросы. Для связи между разными сетями используется механизм Proxy ARP. Все узлы, получившие ARP-запрос, могут сохранить информацию об отправителе в своей таблице, что оптимизирует дальнейший обмен данными. Широковещательный характер ARP создает определенную нагрузку на сеть, поэтому используется кэширование записей для минимизации числа запросов.

**Источники:**
- https://ru.wikipedia.org/wiki/ARP
- https://ru.wikipedia.org/wiki/RARP
- https://intuit.ru/studies/courses/2282/2/lecture/36
- http://kunegin.com/ref6/ip/9.htm
